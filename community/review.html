<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="utf-8">
    <title>대전 괴곡동 농업회사법인 꾸지뽕 사업단 - 구매후기</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/responsive.css">
    <script src="../js/jquery-2.1.4.min.js"></script>
    <script src="../js/common.js"></script>
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
        }

        .subvisual {
            background: url('../images/sub_visual04.jpg') no-repeat center center;
            background-size: cover;
            height: 250px;
            position: relative;
            text-align: center;
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }

        .subvisual h2 span {
            font-size: 36px;
            font-weight: 700;
            text-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
        }

        .subvisual p.title_text02 {
            font-size: 18px;
            margin-top: 15px;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
            line-height: 1.5;
        }

        .tbl_type {
            width: 100%;
            border-top: 2px solid #333;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .tbl_type th,
        .tbl_type td {
            padding: 15px 10px;
            border-bottom: 1px solid #ddd;
            text-align: center;
        }

        .tbl_type th {
            background: #f9f9f9;
            font-weight: bold;
            color: #333;
        }

        .tbl_type td.title {
            text-align: left;
        }

        .tbl_type a {
            text-decoration: none;
            color: #333;
        }

        .tbl_type a:hover {
            text-decoration: underline;
        }

        .btn_box {
            margin-top: 20px;
            text-align: right;
        }

        .list_write_btn2 {
            display: inline-block;
            padding: 10px 20px;
            background: #333;
            color: #fff;
            text-decoration: none;
            border-radius: 5px;
        }

        .list_write_btn2:hover {
            background: #555;
        }

        /* Write Form & View */
        #write_form_container,
        #view_container {
            margin-top: 30px;
        }

        input[type="text"],
        input[type="password"],
        textarea,
        select,
        input[type="file"] {
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 5px;
            font-size: 14px;
        }
    </style>
</head>

<body>
    <div id="wrap">
        <div class="menu_area">
            <div class="sub_logo">
                <a href="../index.html" target="_self"><img src="../images/logo_v2.jpg" alt="대전꾸지뽕"
                        style="height: 50px; width: auto;" /></a>
            </div>
            <div class="menu">
                <div class="menu_tab">
                    <ul class="gnb">
                        <li class="menu1_"><a href="../shop/list.html">상품안내</a></li>
                        <li class="menu2_"><a href="../pages/sub02_2.html">회사소개</a></li>
                        <li class="menu3_"><a href="../story/story.html">꾸지뽕이야기</a></li>
                        <li class="menu4_1_"><a href="../pages/sesim_gwitteumbong.html">세심귀뜸봉</a></li>
                        <li class="menu4_"><a href="../community/testimonials.html">체험인터뷰</a></li>
                        <li class="menu7_"><a href="../gallery/farm.html">농장갤러리</a></li>
                        <li class="menu5_">
                            <a href="../community/notice.html" class="on_menu_active">커뮤니티</a>
                            <ul>
                                <li><a href="../community/notice.html">공지사항</a></li>
                                <li><a href="../community/inquiry.html">문의</a></li>
                                <li><a href="../community/review.html" class="on_menu_active">구매후기</a></li>
                            </ul>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Hero Section -->
        <div class="subvisual">
            <div class="subvisual_text01">
                <h2><span>구매후기</span></h2>
                <p class="title_text02">
                    고객님들의 소중한 구매 후기를<br>
                    확인하실 수 있습니다.
                </p>
            </div>
        </div>

        <div class="subcontent" style="width: 1200px; margin: 0 auto; padding: 50px 0;">
            <div class="subject1">

                <!-- Review List Table -->
                <table class="tbl_type">
                    <colgroup>
                        <col width="50">
                        <col>
                        <col width="110">
                        <col width="100">
                        <col width="80">
                    </colgroup>
                    <thead>
                        <tr>
                            <th scope="col">번호</th>
                            <th scope="col">제목</th>
                            <th scope="col">작성자</th>
                            <th scope="col">날짜</th>
                            <th scope="col">평점</th>
                        </tr>
                    </thead>
                    <tbody id="review-list-container">
                        <!-- Dynamic Content -->
                    </tbody>
                </table>

                <div class="btn_box">
                    <a href="#" onclick="toggleWriteForm(); return false;" class="list_write_btn2">글쓰기</a>
                </div>

                <div id="pagingNew"></div>

                <!-- Detail View (Hidden by default) -->
                <div id="view_container" style="display:none;">
                    <div
                        style="border-top: 2px solid #333; border-bottom: 1px solid #ddd; padding: 20px; background: #fff;">
                        <h3 id="view_title" style="font-size: 24px; font-weight: bold; margin-bottom: 10px;"></h3>
                        <div
                            style="font-size: 14px; color: #888; border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 20px;">
                            <span id="view_author" style="margin-right: 20px;"></span>
                            <span id="view_date"></span>
                            <span id="view_rating" style="margin-left: 20px; color:#fabb00;"></span>
                        </div>

                        <!-- File Attachment Area -->
                        <div id="view_file_area" style="margin-bottom: 20px;"></div>

                        <div id="view_content" style="min-height: 200px; line-height: 1.6; font-size: 16px;"></div>
                    </div>

                    <!-- Comment Section -->
                    <div id="comment-section"></div>

                    <div style="text-align: center; margin-top: 30px;">
                        <button onclick="showList()"
                            style="padding: 10px 30px; background: #666; color: #fff; border: none; cursor: pointer; border-radius: 5px;">목록으로</button>
                    </div>
                </div>

                <!-- Write Form (Hidden by default) -->
                <div id="write_form_container"
                    style="display:none; border: 1px solid #ddd; padding: 30px; background: #f9f9f9; border-radius: 10px;">
                    <h3
                        style="font-size: 20px; font-weight: bold; margin-bottom: 20px; border-bottom: 2px solid #333; padding-bottom: 10px;">
                        구매후기 작성하기</h3>
                    <form onsubmit="submitReview(event)">
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; font-weight: bold; margin-bottom: 5px;">제목</label>
                            <input type="text" id="review_title" required style="width: 100%;">
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; font-weight: bold; margin-bottom: 5px;">작성자</label>
                            <input type="text" id="review_author" required style="width: 100%;">
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; font-weight: bold; margin-bottom: 5px;">평점</label>
                            <select id="review_rating" style="width: 100%;">
                                <option value="5">★★★★★ (5점)</option>
                                <option value="4">★★★★☆ (4점)</option>
                                <option value="3">★★★☆☆ (3점)</option>
                                <option value="2">★★☆☆☆ (2점)</option>
                                <option value="1">★☆☆☆☆ (1점)</option>
                            </select>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; font-weight: bold; margin-bottom: 5px;">내용</label>
                            <textarea id="review_content" required
                                style="width: 100%; height: 200px; resize: none;"></textarea>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; font-weight: bold; margin-bottom: 5px;">첨부파일</label>
                            <input type="file" id="review_file" style="background: #fff; width: 100%;">
                            <p style="font-size: 12px; color: #888; margin-top: 5px;">이미지(jpg, png, gif) 또는 동영상 파일.</p>
                        </div>
                        <div style="text-align: center;">
                            <button type="submit"
                                style="padding: 10px 30px; background: #c31d22; color: #fff; border: none; font-size: 16px; cursor: pointer; border-radius: 5px;">등록하기</button>
                            <button type="button" onclick="toggleWriteForm()"
                                style="padding: 10px 30px; background: #666; color: #fff; border: none; font-size: 16px; cursor: pointer; margin-left: 10px; border-radius: 5px;">취소</button>
                        </div>
                    </form>
                </div>

                <script src="../js/community_common.js"></script>
                <script>
                    const BOARD_KEY = COMM_KEYS.REVIEW;

                    function toggleWriteForm() {
                        var form = document.getElementById('write_form_container');
                        var list = document.querySelector('.tbl_type');
                        var btnBox = document.querySelector('.btn_box');
                        var view = document.getElementById('view_container');
                        var paging = document.getElementById('pagingNew');

                        if (form.style.display === 'none') {
                            form.style.display = 'block';
                            list.style.display = 'none';
                            btnBox.style.display = 'none';
                            view.style.display = 'none';
                            paging.style.display = 'none';
                            form.scrollIntoView({ behavior: "smooth" });
                        } else {
                            showList();
                        }
                    }

                    function showList() {
                        document.getElementById('write_form_container').style.display = 'none';
                        document.getElementById('view_container').style.display = 'none';
                        document.querySelector('.tbl_type').style.display = 'table';
                        document.querySelector('.btn_box').style.display = 'block';
                        document.getElementById('pagingNew').style.display = 'block';
                        renderReviewList('review-list-container');
                        history.pushState(null, null, location.pathname);
                    }

                    async function submitReview(e) {
                        e.preventDefault();
                        var title = document.getElementById('review_title').value;
                        var author = document.getElementById('review_author').value;
                        var content = document.getElementById('review_content').value;
                        var rating = document.getElementById('review_rating').value;
                        var fileInput = document.getElementById('review_file');
                        var date = new Date().toISOString().split('T')[0];

                        const fileData = await readFile(fileInput.files[0]);

                        var newReview = {
                            title: title,
                            author: author,
                            content: content,
                            rating: rating,
                            date: date,
                            file: fileData
                        };

                        savePost(BOARD_KEY, newReview);

                        alert('후기가 등록되었습니다.');
                        document.querySelector('form').reset();
                        showList();
                    }

                    function renderReviewList(containerId, limit = 0) {
                        let reviews = getPosts(BOARD_KEY);
                        const tbody = document.getElementById(containerId);
                        if (!tbody) return;

                        reviews.sort((a, b) => new Date(b.date) - new Date(a.date));

                        let html = '';
                        const displayReviews = limit > 0 ? reviews.slice(0, limit) : reviews;

                        if (displayReviews.length === 0) {
                            const colspan = limit > 0 ? 1 : 5;
                            html = `<tr><td colspan="${colspan}" style="text-align:center; padding: 50px;">등록된 후기가 없습니다.</td></tr>`;
                        } else {
                            displayReviews.forEach((review, index) => {
                                const starMap = {
                                    '5': '★★★★★', '4': '★★★★☆', '3': '★★★☆☆', '2': '★★☆☆☆', '1': '★☆☆☆☆'
                                };
                                const stars = starMap[review.rating] || '★★★★★';

                                if (limit > 0) {
                                    html += `
                                        <tr>
                                            <td class="latest_space">
                                                <a href="community/review.html?id=${review.id}">${review.title}</a>
                                            </td>
                                        </tr>
                                    `;
                                } else {
                                    html += `
                                        <tr onmouseover="this.style.backgroundColor='#fcfcfc'" onmouseout="this.style.backgroundColor=''">
                                            <td class="num">${reviews.length - index}</td>
                                            <td class="title" style="text-align:left; padding-left:10px;">
                                                <a href="#" onclick="viewPost(event, ${review.id})">${review.title}</a>
                                                ${review.file ? '<img src="../images/icon_file.gif" style="vertical-align:middle; margin-left:5px;">' : ''}
                                            </td>
                                            <td class="name"><span class="guest">${review.author}</span></td>
                                            <td class="date">${review.date}</td>
                                            <td class="status" style="color:#fabb00;">${stars}</td>
                                        </tr>
                                    `;
                                }
                            });
                        }
                        tbody.innerHTML = html;
                    }

                    function viewPost(e, id) {
                        if (e) e.preventDefault();
                        const post = getPost(BOARD_KEY, id);
                        if (!post) {
                            alert('존재하지 않는 게시물입니다.');
                            return;
                        }
                        const starMap = {
                            '5': '★★★★★', '4': '★★★★☆', '3': '★★★☆☆', '2': '★★☆☆☆', '1': '★☆☆☆☆'
                        };

                        document.getElementById('view_title').innerText = post.title;
                        document.getElementById('view_author').innerText = post.author;
                        document.getElementById('view_date').innerText = post.date;
                        document.getElementById('view_rating').innerText = starMap[post.rating] || '';
                        document.getElementById('view_content').innerText = post.content;

                        const fileArea = document.getElementById('view_file_area');
                        fileArea.innerHTML = '';
                        if (post.file) {
                            if (post.file.data) {
                                fileArea.innerHTML = `<img src="${post.file.data}" style="max-width:100%; margin-top:10px;">`;
                            } else {
                                fileArea.innerHTML = `<div style="background:#eee; padding:10px; margin-top:10px;">첨부파일: ${post.file.name} (${Math.round(post.file.size / 1024)}KB)</div>`;
                            }
                        }

                        document.getElementById('view_container').style.display = 'block';
                        document.querySelector('.tbl_type').style.display = 'none';
                        document.querySelector('.btn_box').style.display = 'none';
                        document.getElementById('pagingNew').style.display = 'none';

                        renderCommentSection('comment-section', BOARD_KEY, post.id);
                        history.pushState({ id: id }, null, `?id=${id}`);
                    }

                    window.onload = function () {
                        const urlParams = new URLSearchParams(window.location.search);
                        const id = urlParams.get('id');
                        if (id) {
                            viewPost(null, id);
                        } else {
                            renderReviewList('review-list-container');
                        }
                    }

                    window.onpopstate = function (event) {
                        if (event.state && event.state.id) {
                            viewPost(null, event.state.id);
                        } else {
                            showList();
                        }
                    };
                </script>
            </div>
        </div>

        <div id="copy" style="background:#333; color:#aaa; padding:20px; text-align:center; margin-top:50px;">
            <p>COPYRIGHT 2025(C) 농업회사법인 꾸지뽕 사업단 ALL RIGHTS RESERVED.</p>
        </div>
    </div>
</body>

</html>